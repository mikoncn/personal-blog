<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase å®Œæ•´è¯Šæ–­</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Courier New', monospace;
      padding: 20px;
      background: #0a0a0a;
      color: #00ff00;
      line-height: 1.6;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { 
      color: #00ff00; 
      text-shadow: 0 0 10px #00ff00;
      margin-bottom: 20px;
      border-bottom: 2px solid #00ff00;
      padding-bottom: 10px;
    }
    h2 {
      color: #00ffff;
      margin: 30px 0 15px 0;
      font-size: 1.2rem;
    }
    .log {
      margin: 10px 0;
      padding: 15px;
      border-left: 4px solid #00ff00;
      background: rgba(0, 255, 0, 0.05);
      border-radius: 4px;
    }
    .error {
      border-left-color: #ff0000;
      color: #ff0000;
      background: rgba(255, 0, 0, 0.1);
    }
    .success {
      border-left-color: #00ff00;
      color: #00ff00;
    }
    .warning {
      border-left-color: #ffff00;
      color: #ffff00;
      background: rgba(255, 255, 0, 0.1);
    }
    .info {
      border-left-color: #00ffff;
      color: #00ffff;
    }
    pre {
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 0.9rem;
    }
    .test-result {
      margin: 10px 0;
      padding: 10px;
      background: rgba(0, 255, 0, 0.1);
      border: 1px solid #00ff00;
      border-radius: 4px;
    }
    .test-result.failed {
      background: rgba(255, 0, 0, 0.1);
      border-color: #ff0000;
    }
    button {
      background: #00ff00;
      color: #0a0a0a;
      border: none;
      padding: 10px 20px;
      margin: 10px 5px;
      cursor: pointer;
      font-family: inherit;
      font-weight: bold;
      border-radius: 4px;
      transition: all 0.3s;
    }
    button:hover {
      background: #00ffff;
      box-shadow: 0 0 20px #00ffff;
    }
    .summary {
      margin-top: 30px;
      padding: 20px;
      background: rgba(0, 255, 255, 0.1);
      border: 2px solid #00ffff;
      border-radius: 8px;
    }
    .summary h3 {
      color: #00ffff;
      margin-bottom: 15px;
    }
    .solution {
      margin: 10px 0;
      padding: 10px;
      background: rgba(255, 255, 0, 0.1);
      border-left: 4px solid #ffff00;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” Supabase å®Œæ•´è¯Šæ–­å·¥å…·</h1>
    
    <div class="info log">
      <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
      1. ç‚¹å‡»"å¼€å§‹è¯Šæ–­"æŒ‰é’®<br>
      2. æŸ¥çœ‹æ‰€æœ‰æµ‹è¯•ç»“æœ<br>
      3. æ ¹æ®è¯Šæ–­ç»“æœé‡‡å–ç›¸åº”æªæ–½
    </div>

    <button onclick="runDiagnostics()">ğŸš€ å¼€å§‹è¯Šæ–­</button>
    <button onclick="clearLogs()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>

    <div id="logs"></div>

    <div id="summary" class="summary" style="display: none;">
      <h3>ğŸ“‹ è¯Šæ–­æ€»ç»“</h3>
      <div id="summaryContent"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

    const SUPABASE_URL = 'https://twjantrzbprehxcmlszj.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3amFudHJ6YnByZWh4Y21sc3pqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY5ODk5OTIsImV4cCI6MjA4MjU2NTk5Mn0.NOaB1vUOj4P_CmGRc1a6tIYy3MDBy-U4b_THH3foz48'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    const testResults = []

    function log(message, type = 'info', details = null) {
      const logsDiv = document.getElementById('logs')
      const logDiv = document.createElement('div')
      logDiv.className = `log ${type}`
      
      let content = message
      if (details) {
        content += `\n<pre>${JSON.stringify(details, null, 2)}</pre>`
      }
      logDiv.innerHTML = content
      logsDiv.appendChild(logDiv)
      console.log(`[${type.toUpperCase()}]`, message, details || '')
    }

    function recordTest(testName, passed, details = '') {
      testResults.push({ name: testName, passed, details })
    }

    function clearLogs() {
      document.getElementById('logs').innerHTML = ''
      document.getElementById('summary').style.display = 'none'
      testResults.length = 0
    }

    async function runDiagnostics() {
      clearLogs()
      log('=== âš”ï¸ å¸å›½å®¡åˆ¤åº­ - ç¥åœ£æœºæ¢°ç¥æ®¿è¯Šæ–­ç¨‹åºå¯åŠ¨ âš”ï¸ ===', 'info')
      log(`ğŸ”— æœºæ¢°ç¥æ®¿åæ ‡: ${SUPABASE_URL}`, 'info')
      log(`ğŸ”‘ ç¥åœ£å¯†é’¥: ${SUPABASE_ANON_KEY.substring(0, 30)}...`, 'info')

      try {
        // æµ‹è¯• 1: åŸºæœ¬è¿æ¥
        log('\nğŸ“¡ æµ‹è¯• 1: ç¥åœ£è¿æ¥æµ‹è¯•', 'info')
        try {
          const { data: sessionData, error: sessionError } = await supabase.auth.getSession()
          if (sessionError) {
            log(`â˜ ï¸ å¼‚ç«¯å…¥ä¾µï¼è¿æ¥å¤±è´¥: ${sessionError.message}`, 'error', sessionError)
            recordTest('ç¥åœ£è¿æ¥', false, sessionError.message)
          } else {
            log('âœ¨ è£è€€å½’äºæœºæ¢°ä¹‹ç¥ï¼è¿æ¥æˆåŠŸï¼', 'success')
            recordTest('ç¥åœ£è¿æ¥', true)
          }
        } catch (err) {
          log(`â˜ ï¸ å¼‚ç«¯å…¥ä¾µï¼è¿æ¥å¼‚å¸¸: ${err.message}`, 'error', err)
          recordTest('ç¥åœ£è¿æ¥', false, err.message)
        }

        // æµ‹è¯• 2: å°è¯•ä¸åŒçš„è¡¨å
        log('\nğŸ“‹ æµ‹è¯• 2: æœå¯»ç¥åœ£åœ£å…¸è¡¨', 'info')
        const tableNames = ['posts', 'Posts', 'POSTS', 'post', 'Post', 'POST']
        let foundTable = null
        
        for (const tableName of tableNames) {
          try {
            const { data, error } = await supabase
              .from(tableName)
              .select('*')
              .limit(1)
            
            if (!error) {
              log(`âœ¨ æ‰¾åˆ°ç¥åœ£åœ£å…¸è¡¨: "${tableName}"`, 'success')
              log(`   ğŸ“œ è¿”å›æ•°æ®: ${data.length} æ¡è®°å½•`, 'success')
              if (data.length > 0) {
                log(`   ğŸ“– ç¤ºä¾‹åœ£å…¸:`, 'success', data[0])
              }
              foundTable = tableName
              recordTest(`åœ£å…¸è¡¨ ${tableName}`, true)
              break
            } else {
              log(`âš ï¸ è¡¨ "${tableName}" ä¸å­˜åœ¨æˆ–æ— æƒé™: ${error.message}`, 'warning')
              recordTest(`åœ£å…¸è¡¨ ${tableName}`, false, error.message)
            }
          } catch (err) {
            log(`â˜ ï¸ è¡¨ "${tableName}" æŸ¥è¯¢å¼‚å¸¸: ${err.message}`, 'error')
            recordTest(`åœ£å…¸è¡¨ ${tableName}`, false, err.message)
          }
        }

        // æµ‹è¯• 3: è·å–æ‰€æœ‰æ•°æ®
        if (foundTable) {
          log(`\nğŸ“š æµ‹è¯• 3: ä»åœ£å…¸è¡¨ "${foundTable}" æ£€ç´¢æ‰€æœ‰åœ£å…¸`, 'info')
          try {
            const { data: allData, error: allError } = await supabase
              .from(foundTable)
              .select('*')
              .order('created_at', { ascending: false })

            if (allError) {
              log(`â˜ ï¸ å¼‚ç«¯å…¥ä¾µï¼æ£€ç´¢å¤±è´¥: ${allError.message}`, 'error', allError)
              recordTest('åœ£å…¸æ£€ç´¢', false, allError.message)
            } else {
              log(`âœ¨ è£è€€å½’äºæœºæ¢°ä¹‹ç¥ï¼æˆåŠŸæ£€ç´¢ ${allData.length} ç¯‡åœ£å…¸`, 'success')
              allData.forEach((item, index) => {
                log(`   ğŸ“– åœ£å…¸ ${index + 1}: ${item.title || item.name || 'æ— æ ‡é¢˜'} (ID: ${item.id})`, 'success')
              })
              recordTest('åœ£å…¸æ£€ç´¢', true, `å…± ${allData.length} ç¯‡`)
            }
          } catch (err) {
            log(`â˜ ï¸ å¼‚ç«¯å…¥ä¾µï¼æ£€ç´¢å¼‚å¸¸: ${err.message}`, 'error', err)
            recordTest('åœ£å…¸æ£€ç´¢', false, err.message)
          }
        }

        // æµ‹è¯• 4: æ£€æŸ¥ RLS ç­–ç•¥
        log('\nğŸ›¡ï¸ æµ‹è¯• 4: æ£€æŸ¥ç¥åœ£é˜²æŠ¤ç­–ç•¥ï¼ˆRLSï¼‰', 'info')
        log('âš ï¸  æ³¨æ„ï¼šæ­¤æµ‹è¯•éœ€è¦æœºæ¢°ç¥ç”«æƒé™', 'warning')
        log('è¯·åœ¨ Supabase æ§åˆ¶å°ä¸­æ£€æŸ¥ï¼š', 'info')
        log('1. Authentication > Policies > posts è¡¨', 'info')
        log('2. ç¡®ä¿æœ‰å…è®¸åŒ¿åç”¨æˆ·è¯»å–çš„ç­–ç•¥', 'info')
        log('3. æˆ–ä¸´æ—¶ç¦ç”¨ RLS è¿›è¡Œæµ‹è¯•', 'info')
        recordTest('RLS ç­–ç•¥æ£€æŸ¥', null, 'éœ€è¦æ‰‹åŠ¨æ£€æŸ¥')

        // æµ‹è¯• 5: ç¯å¢ƒå˜é‡æ£€æŸ¥
        log('\nâš™ï¸  æµ‹è¯• 5: ç¥åœ£ç¯å¢ƒå˜é‡æ£€æŸ¥', 'info')
        log('è¯·åœ¨é¡¹ç›®ä¸­æ£€æŸ¥ï¼š', 'info')
        log('1. .env æ–‡ä»¶æ˜¯å¦å­˜åœ¨', 'info')
        log('2. VITE_SUPABASE_URL æ˜¯å¦æ­£ç¡®', 'info')
        log('3. VITE_SUPABASE_ANON_KEY æ˜¯å¦æ­£ç¡®', 'info')
        log('4. é‡å¯å¼€å‘æœåŠ¡å™¨: npm run dev', 'info')
        recordTest('ç¯å¢ƒå˜é‡æ£€æŸ¥', null, 'éœ€è¦æ‰‹åŠ¨æ£€æŸ¥')

        // ç”Ÿæˆæ€»ç»“
        generateSummary(foundTable)

      } catch (err) {
        log(`\nâ˜ ï¸ è¯Šæ–­è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸: ${err.message}`, 'error', err)
        log(`å¼‚å¸¸å †æ ˆ: ${err.stack}`, 'error')
      }

      log('\n=== âš”ï¸ è¯Šæ–­å®Œæˆ âš”ï¸ ===', 'info')
    }

    function generateSummary(foundTable) {
      const summaryDiv = document.getElementById('summary')
      const summaryContent = document.getElementById('summaryContent')
      
      let html = '<h4>ğŸ“Š ç¥åœ£è¯Šæ–­ç»“æœç»Ÿè®¡</h4>'
      html += '<ul>'
      
      const passed = testResults.filter(t => t.passed === true).length
      const failed = testResults.filter(t => t.passed === false).length
      const skipped = testResults.filter(t => t.passed === null).length
      
      html += `<li>âœ¨ è£è€€é€šè¿‡: ${passed}</li>`
      html += `<li>â˜ ï¸ å¼‚ç«¯å¤±è´¥: ${failed}</li>`
      html += `<li>âš ï¸ éœ€è¦å®¡åˆ¤åº­æ£€æŸ¥: ${skipped}</li>`
      html += '</ul>'

      if (foundTable) {
        html += `<div class="solution success">âœ¨ æ‰¾åˆ°ç¥åœ£åœ£å…¸è¡¨: <strong>${foundTable}</strong></div>`
        html += '<div class="solution">âš”ï¸ è§£å†³æ–¹æ¡ˆ: æ›´æ–° postService.js ä¸­çš„è¡¨å</div>'
        html += `<pre>from('${foundTable}')</pre>`
      } else {
        html += '<div class="solution failed">â˜ ï¸ æœªæ‰¾åˆ°ä»»ä½•åœ£å…¸è¡¨</div>'
        html += '<div class="solution">ğŸ’€ å¼‚ç«¯å…¥ä¾µçš„å¯èƒ½åŸå› ï¼š</div>'
        html += '<ul>'
        html += '<li>1. åœ£å…¸è¡¨åä¸æ˜¯å¸¸è§çš„å˜ä½“ï¼ˆposts/Posts/POSTSï¼‰</li>'
        html += '<li>2. ç¥åœ£é˜²æŠ¤ç­–ç•¥ï¼ˆRLSï¼‰é˜»æ­¢äº†å¼‚ç«¯è®¿é—®</li>'
        html += '<li>3. åœ£å…¸è¡¨åœ¨ä¸åŒçš„ç¥åœ£ç»´åº¦ï¼ˆschemaï¼‰ä¸­</li>'
        html += '</ul>'
        html += '<div class="solution">âš”ï¸ å¸å›½å®¡åˆ¤åº­è§£å†³æ–¹æ¡ˆï¼š</div>'
        html += '<ol>'
        html += '<li>åœ¨ Supabase ç¥åœ£ SQL Editor ä¸­æ‰§è¡Œ: SELECT * FROM information_schema.tables WHERE table_schema = \'public\';</li>'
        html += '<li>æ£€æŸ¥ Authentication > Policiesï¼Œç¡®ä¿æœ‰å…è®¸å¼‚ç«¯è¯»å–çš„ç­–ç•¥</li>'
        html += '<li>æˆ–ä¸´æ—¶ç¦ç”¨ç¥åœ£é˜²æŠ¤: ALTER TABLE posts DISABLE ROW LEVEL SECURITY;</li>'
        html += '</ol>'
      }

      summaryContent.innerHTML = html
      summaryDiv.style.display = 'block'
    }

    window.runDiagnostics = runDiagnostics
    window.clearLogs = clearLogs
  </script>
</body>
</html>
